<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JmsMessageTransformation.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QpidJMS Client with AMQP acknowledgement</a> &gt; <a href="index.source.html" class="el_package">org.apache.qpid.jms.message</a> &gt; <span class="el_source">JmsMessageTransformation.java</span></div><h1>JmsMessageTransformation.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.qpid.jms.message;

import java.util.Enumeration;

import javax.jms.BytesMessage;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.MapMessage;
import javax.jms.Message;
import javax.jms.MessageEOFException;
import javax.jms.ObjectMessage;
import javax.jms.Queue;
import javax.jms.StreamMessage;
import javax.jms.TemporaryQueue;
import javax.jms.TemporaryTopic;
import javax.jms.TextMessage;
import javax.jms.Topic;

import org.apache.qpid.jms.JmsConnection;
import org.apache.qpid.jms.JmsDestination;
import org.apache.qpid.jms.JmsQueue;
import org.apache.qpid.jms.JmsTemporaryQueue;
import org.apache.qpid.jms.JmsTemporaryTopic;
import org.apache.qpid.jms.JmsTopic;

/**
 * A helper class for converting normal JMS interfaces into the QpidJMS specific
 * versions.
 */
<span class="fc" id="L46">public final class JmsMessageTransformation {</span>

<span class="fc" id="L48">    private static JmsUnresolvedDestinationTransformer unresolvedDestinationHandler =</span>
        new JmsDefaultUnresolvedDestinationTransformer();

    /**
     * Creates a an available JMS message from another provider.
     *
     * @param destination
     *        - Destination to be converted into Jms's implementation.
     * @return JmsDestination - Jms's implementation of the
     *         destination.
     * @throws JMSException
     * @throws JMSException
     *         if an error occurs
     */
    public static JmsDestination transformDestination(JmsConnection connection, Destination destination) throws JMSException {
<span class="fc" id="L63">        JmsDestination result = null;</span>

<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (destination != null) {</span>

<span class="fc bfc" id="L67" title="All 2 branches covered.">            if (destination instanceof JmsDestination) {</span>
<span class="fc" id="L68">                result = (JmsDestination) destination;</span>
<span class="fc bfc" id="L69" title="All 4 branches covered.">            } else if (destination instanceof Queue &amp;&amp; destination instanceof Topic) {</span>
<span class="fc" id="L70">                String queueName = ((Queue) destination).getQueueName();</span>
<span class="fc" id="L71">                String topicName = ((Topic) destination).getTopicName();</span>
<span class="fc bfc" id="L72" title="All 4 branches covered.">                if (queueName != null &amp;&amp; topicName == null) {</span>
<span class="fc" id="L73">                    result = new JmsQueue(queueName);</span>
<span class="fc bfc" id="L74" title="All 4 branches covered.">                } else if (queueName == null &amp;&amp; topicName != null) {</span>
<span class="fc" id="L75">                    result = new JmsTopic(topicName);</span>
                } else {
<span class="fc" id="L77">                    result = unresolvedDestinationHandler.transform(destination);</span>
                }
<span class="fc" id="L79">            } else {</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">                if (destination instanceof TemporaryQueue) {</span>
<span class="fc" id="L81">                    result = new JmsTemporaryQueue(((TemporaryQueue) destination).getQueueName());</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">                } else if (destination instanceof TemporaryTopic) {</span>
<span class="fc" id="L83">                    result = new JmsTemporaryTopic(((TemporaryTopic) destination).getTopicName());</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">                } else if (destination instanceof Queue) {</span>
<span class="fc" id="L85">                    result = new JmsQueue(((Queue) destination).getQueueName());</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">                } else if (destination instanceof Topic) {</span>
<span class="fc" id="L87">                    result = new JmsTopic(((Topic) destination).getTopicName());</span>
                } else {
<span class="fc" id="L89">                    result = unresolvedDestinationHandler.transform(destination);</span>
                }
            }
        }

<span class="fc" id="L94">        return result;</span>
    }

    /**
     * Creates a fast shallow copy of the current JmsMessage or creates a
     * whole new message instance from an available JMS message from another
     * provider.
     *
     * @param message
     *        Message to be converted into Jms's implementation.
     * @param connection
     *        The JmsConnection where this transformation is being initiated.
     *
     * @return JmsMessage
     *         The client's implementation object for the incoming message.
     *
     * @throws JMSException if an error occurs during the copy.
     */
    public static JmsMessage transformMessage(JmsConnection connection, Message message) throws JMSException {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (message instanceof JmsMessage) {</span>
<span class="fc" id="L114">            return ((JmsMessage) message).copy();</span>
        } else {
<span class="fc" id="L116">            JmsMessage activeMessage = null;</span>
<span class="fc" id="L117">            JmsMessageFactory factory = connection.getMessageFactory();</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (message instanceof BytesMessage) {</span>
<span class="fc" id="L120">                BytesMessage bytesMsg = (BytesMessage) message;</span>
<span class="fc" id="L121">                bytesMsg.reset();</span>
<span class="fc" id="L122">                JmsBytesMessage msg = factory.createBytesMessage();</span>
                try {
                    for (;;) {
                        // Reads a byte from the message stream until the stream is empty
<span class="fc" id="L126">                        msg.writeByte(bytesMsg.readByte());</span>
                    }
<span class="fc" id="L128">                } catch (MessageEOFException e) {</span>
                    // Indicates all the bytes have been read from the source.
                }

<span class="fc" id="L132">                activeMessage = msg;</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">            } else if (message instanceof MapMessage) {</span>
<span class="fc" id="L134">                MapMessage mapMsg = (MapMessage) message;</span>
<span class="fc" id="L135">                JmsMapMessage msg = factory.createMapMessage();</span>
<span class="fc" id="L136">                Enumeration&lt;?&gt; iter = mapMsg.getMapNames();</span>

<span class="fc bfc" id="L138" title="All 2 branches covered.">                while (iter.hasMoreElements()) {</span>
<span class="fc" id="L139">                    String name = iter.nextElement().toString();</span>
<span class="fc" id="L140">                    msg.setObject(name, mapMsg.getObject(name));</span>
<span class="fc" id="L141">                }</span>

<span class="fc" id="L143">                activeMessage = msg;</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">            } else if (message instanceof ObjectMessage) {</span>
<span class="fc" id="L145">                ObjectMessage objMsg = (ObjectMessage) message;</span>
<span class="fc" id="L146">                JmsObjectMessage msg = factory.createObjectMessage();</span>
<span class="fc" id="L147">                msg.setObject(objMsg.getObject());</span>
<span class="fc" id="L148">                activeMessage = msg;</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            } else if (message instanceof StreamMessage) {</span>
<span class="fc" id="L150">                StreamMessage streamMessage = (StreamMessage) message;</span>
<span class="fc" id="L151">                streamMessage.reset();</span>
<span class="fc" id="L152">                JmsStreamMessage msg = factory.createStreamMessage();</span>
<span class="fc" id="L153">                Object obj = null;</span>

                try {
<span class="fc bfc" id="L156" title="All 2 branches covered.">                    while ((obj = streamMessage.readObject()) != null) {</span>
<span class="fc" id="L157">                        msg.writeObject(obj);</span>
                    }
<span class="fc" id="L159">                } catch (MessageEOFException e) {</span>
                    // Indicates all the stream values have been read from the source.
<span class="fc" id="L161">                }</span>

<span class="fc" id="L163">                activeMessage = msg;</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">            } else if (message instanceof TextMessage) {</span>
<span class="fc" id="L165">                TextMessage textMsg = (TextMessage) message;</span>
<span class="fc" id="L166">                JmsTextMessage msg = factory.createTextMessage();</span>
<span class="fc" id="L167">                msg.setText(textMsg.getText());</span>
<span class="fc" id="L168">                activeMessage = msg;</span>
<span class="fc" id="L169">            } else {</span>
<span class="fc" id="L170">                activeMessage = factory.createMessage();</span>
            }

<span class="fc" id="L173">            copyProperties(connection, message, activeMessage);</span>

<span class="fc" id="L175">            return activeMessage;</span>
        }
    }

    /**
     * Copies the standard JMS and user defined properties from the given source
     * message to the specified target message.  The copy can only handle the JMS
     * specific message properties and known JMS Headers, any headers that are
     * specific to the foreign message may be lost if not returned directly via
     * the &lt;code&gt;propertyNames&lt;/code&gt; method.
     *
     * @param source
     *        the message to take the properties from
     * @param target
     *        the message to add the properties to
     *
     * @throws JMSException if an error occurs during the copy of message properties.
     */
    public static void copyProperties(JmsConnection connection, Message source, Message target) throws JMSException {
<span class="fc" id="L194">        target.setJMSMessageID(source.getJMSMessageID());</span>
<span class="fc" id="L195">        target.setJMSCorrelationID(source.getJMSCorrelationID());</span>
<span class="fc" id="L196">        target.setJMSReplyTo(transformDestination(connection, source.getJMSReplyTo()));</span>
<span class="fc" id="L197">        target.setJMSDestination(transformDestination(connection, source.getJMSDestination()));</span>
<span class="fc" id="L198">        target.setJMSDeliveryMode(source.getJMSDeliveryMode());</span>
<span class="fc" id="L199">        target.setJMSRedelivered(source.getJMSRedelivered());</span>
<span class="fc" id="L200">        target.setJMSType(source.getJMSType());</span>
<span class="fc" id="L201">        target.setJMSExpiration(source.getJMSExpiration());</span>
<span class="fc" id="L202">        target.setJMSPriority(source.getJMSPriority());</span>
<span class="fc" id="L203">        target.setJMSTimestamp(source.getJMSTimestamp());</span>

<span class="fc" id="L205">        Enumeration&lt;?&gt; propertyNames = source.getPropertyNames();</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">        while (propertyNames.hasMoreElements()) {</span>
<span class="fc" id="L208">            String name = propertyNames.nextElement().toString();</span>
<span class="fc" id="L209">            Object obj = source.getObjectProperty(name);</span>
<span class="fc" id="L210">            target.setObjectProperty(name, obj);</span>
<span class="fc" id="L211">        }</span>
<span class="fc" id="L212">    }</span>

    public static void setUnresolvedDestinationHandler(JmsUnresolvedDestinationTransformer handler) {
<span class="fc" id="L215">        unresolvedDestinationHandler = handler;</span>
<span class="fc" id="L216">    }</span>

    public static JmsUnresolvedDestinationTransformer getUnresolvedDestinationTransformer() {
<span class="fc bfc" id="L219" title="All 2 branches covered.">        if (unresolvedDestinationHandler == null) {</span>
<span class="fc" id="L220">            unresolvedDestinationHandler = new JmsDefaultUnresolvedDestinationTransformer();</span>
        }

<span class="fc" id="L223">        return unresolvedDestinationHandler;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>