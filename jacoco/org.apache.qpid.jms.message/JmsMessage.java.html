<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JmsMessage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QpidJMS Client with AMQP acknowledgement</a> &gt; <a href="index.source.html" class="el_package">org.apache.qpid.jms.message</a> &gt; <span class="el_source">JmsMessage.java</span></div><h1>JmsMessage.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.qpid.jms.message;

import java.util.Collections;
import java.util.Enumeration;
import java.util.HashSet;
import java.util.Set;

import javax.jms.DeliveryMode;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.MessageFormatException;
import javax.jms.MessageNotReadableException;
import javax.jms.MessageNotWriteableException;

import org.apache.qpid.jms.JmsConnection;
import org.apache.qpid.jms.exceptions.JmsExceptionSupport;
import org.apache.qpid.jms.message.facade.JmsMessageFacade;
import org.apache.qpid.jms.provider.ProviderConstants;
import org.apache.qpid.jms.util.TypeConversionSupport;

public class JmsMessage implements JmsAmqpMessage
{

    private static final String ID_PREFIX = &quot;ID:&quot;;
    protected transient JmsAcknowledgeCallback acknowledgeCallback;
    protected transient JmsConnection connection;

    protected final JmsMessageFacade facade;
    protected boolean readOnlyBody;
    protected boolean readOnlyProperties;
<span class="fc" id="L47">    protected boolean validatePropertyNames = true;</span>

<span class="fc" id="L49">    public JmsMessage(JmsMessageFacade facade) {</span>
<span class="fc" id="L50">        this.facade = facade;</span>
<span class="fc" id="L51">    }</span>

    public JmsMessage copy() throws JMSException {
<span class="fc" id="L54">        JmsMessage other = new JmsMessage(facade.copy());</span>
<span class="fc" id="L55">        other.copy(this);</span>
<span class="fc" id="L56">        return other;</span>
    }

    protected void copy(JmsMessage other) {
<span class="fc" id="L60">        this.readOnlyBody = other.readOnlyBody;</span>
<span class="fc" id="L61">        this.readOnlyProperties = other.readOnlyBody;</span>
<span class="fc" id="L62">        this.acknowledgeCallback = other.acknowledgeCallback;</span>
<span class="fc" id="L63">        this.connection = other.connection;</span>
<span class="fc" id="L64">        this.validatePropertyNames = other.validatePropertyNames;</span>
<span class="fc" id="L65">    }</span>

    @Override
    public int hashCode() {
<span class="fc" id="L69">        String id = facade.getMessageId();</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (id != null) {</span>
<span class="fc" id="L72">            return id.hashCode();</span>
        } else {
<span class="fc" id="L74">            return super.hashCode();</span>
        }
    }

    @Override
    public boolean equals(Object o) {
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (this == o) {</span>
<span class="fc" id="L81">            return true;</span>
        }
<span class="fc bfc" id="L83" title="All 4 branches covered.">        if (o == null || o.getClass() != getClass()) {</span>
<span class="fc" id="L84">            return false;</span>
        }

<span class="fc" id="L87">        JmsMessage msg = (JmsMessage) o;</span>
<span class="fc" id="L88">        String oMsg = msg.facade.getMessageId();</span>
<span class="fc" id="L89">        String thisMsg = facade.getMessageId();</span>

<span class="fc bfc" id="L91" title="All 6 branches covered.">        return thisMsg != null &amp;&amp; oMsg != null &amp;&amp; oMsg.equals(thisMsg);</span>
    }

    @Override
    public void acknowledge() throws JMSException {
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (acknowledgeCallback != null) {</span>
            try {
<span class="fc" id="L98">                acknowledgeCallback.call(ProviderConstants.ACK_TYPE.CONSUMED);</span>
<span class="fc" id="L99">            } catch (Throwable e) {</span>
<span class="fc" id="L100">                throw JmsExceptionSupport.create(e);</span>
<span class="fc" id="L101">            }</span>
        }
<span class="fc" id="L103">    }</span>

    @Override
    public void acknowledge(ProviderConstants.ACK_TYPE ackType) throws JMSException {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (acknowledgeCallback != null) {</span>
            try {
<span class="nc" id="L109">                acknowledgeCallback.call(ackType);</span>
<span class="nc" id="L110">            } catch (Throwable e) {</span>
<span class="nc" id="L111">                throw JmsExceptionSupport.create(e);</span>
<span class="nc" id="L112">            }</span>
        }
<span class="nc" id="L114">    }</span>

    @Override
    public void clearBody() throws JMSException {
<span class="fc" id="L118">        readOnlyBody = false;</span>
<span class="fc" id="L119">        facade.clearBody();</span>
<span class="fc" id="L120">    }</span>

    public boolean isValidatePropertyNames() {
<span class="fc" id="L123">        return validatePropertyNames;</span>
    }

    public void setValidatePropertyNames(boolean validatePropertyNames) {
<span class="fc" id="L127">        this.validatePropertyNames = validatePropertyNames;</span>
<span class="fc" id="L128">    }</span>

    public boolean isReadOnlyBody() {
<span class="fc" id="L131">        return this.readOnlyBody;</span>
    }

    public void setReadOnlyBody(boolean readOnlyBody) {
<span class="fc" id="L135">        this.readOnlyBody = readOnlyBody;</span>
<span class="fc" id="L136">    }</span>

    public boolean isReadOnlyProperties() {
<span class="fc" id="L139">        return this.readOnlyProperties;</span>
    }

    public void setReadOnlyProperties(boolean readOnlyProperties) {
<span class="fc" id="L143">        this.readOnlyProperties = readOnlyProperties;</span>
<span class="fc" id="L144">    }</span>

    @Override
    public String getJMSMessageID() throws JMSException {
<span class="fc" id="L148">        String value = facade.getMessageId();</span>
<span class="fc bfc" id="L149" title="All 4 branches covered.">        if (value != null &amp;&amp; !value.startsWith(ID_PREFIX)) {</span>
<span class="fc" id="L150">            value = ID_PREFIX + value;</span>
        }

<span class="fc" id="L153">        return value;</span>
    }

    @Override
    public void setJMSMessageID(String value) throws JMSException {
<span class="fc" id="L158">        facade.setMessageId(value);</span>
<span class="fc" id="L159">    }</span>

    @Override
    public long getJMSTimestamp() throws JMSException {
<span class="fc" id="L163">        return facade.getTimestamp();</span>
    }

    @Override
    public void setJMSTimestamp(long timestamp) throws JMSException {
<span class="fc" id="L168">        facade.setTimestamp(timestamp);</span>
<span class="fc" id="L169">    }</span>

    @Override
    public String getJMSCorrelationID() throws JMSException {
<span class="fc" id="L173">        return facade.getCorrelationId();</span>
    }

    @Override
    public void setJMSCorrelationID(String correlationId) throws JMSException {
<span class="fc" id="L178">        facade.setCorrelationId(correlationId);</span>
<span class="fc" id="L179">    }</span>

    @Override
    public byte[] getJMSCorrelationIDAsBytes() throws JMSException {
<span class="fc" id="L183">        return facade.getCorrelationIdBytes();</span>
    }

    @Override
    public void setJMSCorrelationIDAsBytes(byte[] correlationId) throws JMSException {
<span class="fc" id="L188">        facade.setCorrelationIdBytes(correlationId);</span>
<span class="fc" id="L189">    }</span>

    @Override
    public Destination getJMSReplyTo() throws JMSException {
<span class="fc" id="L193">        return facade.getReplyTo();</span>
    }

    @Override
    public void setJMSReplyTo(Destination destination) throws JMSException {
<span class="fc" id="L198">        facade.setReplyTo(JmsMessageTransformation.transformDestination(connection, destination));</span>
<span class="fc" id="L199">    }</span>

    @Override
    public Destination getJMSDestination() throws JMSException {
<span class="fc" id="L203">        return facade.getDestination();</span>
    }

    @Override
    public void setJMSDestination(Destination destination) throws JMSException {
<span class="fc" id="L208">        facade.setDestination(JmsMessageTransformation.transformDestination(connection, destination));</span>
<span class="fc" id="L209">    }</span>

    @Override
    public int getJMSDeliveryMode() throws JMSException {
<span class="fc bfc" id="L213" title="All 2 branches covered.">        return facade.isPersistent() ? DeliveryMode.PERSISTENT : DeliveryMode.NON_PERSISTENT;</span>
    }

    @Override
    public void setJMSDeliveryMode(int mode) throws JMSException {
<span class="fc bfc" id="L218" title="All 2 branches covered.">        facade.setPersistent(mode == DeliveryMode.PERSISTENT);</span>
<span class="fc" id="L219">    }</span>

    @Override
    public boolean getJMSRedelivered() throws JMSException {
<span class="fc" id="L223">        return facade.isRedelivered();</span>
    }

    @Override
    public void setJMSRedelivered(boolean redelivered) throws JMSException {
<span class="fc" id="L228">        facade.setRedelivered(redelivered);</span>
<span class="fc" id="L229">    }</span>

    @Override
    public String getJMSType() throws JMSException {
<span class="fc" id="L233">        return facade.getType();</span>
    }

    @Override
    public void setJMSType(String type) throws JMSException {
<span class="fc" id="L238">        facade.setType(type);</span>
<span class="fc" id="L239">    }</span>

    @Override
    public long getJMSExpiration() throws JMSException {
<span class="fc" id="L243">        return facade.getExpiration();</span>
    }

    @Override
    public void setJMSExpiration(long expiration) throws JMSException {
<span class="fc" id="L248">        facade.setExpiration(expiration);</span>
<span class="fc" id="L249">    }</span>

    @Override
    public int getJMSPriority() throws JMSException {
<span class="fc" id="L253">        return facade.getPriority();</span>
    }

    @Override
    public void setJMSPriority(int priority) throws JMSException {
<span class="fc" id="L258">        facade.setPriority(priority);</span>
<span class="fc" id="L259">    }</span>

    @Override
    public void clearProperties() throws JMSException {
<span class="fc" id="L263">        JmsMessagePropertyIntercepter.clearProperties(facade, true);</span>
<span class="fc" id="L264">    }</span>

    @Override
    public boolean propertyExists(String name) throws JMSException {
        try {
<span class="fc" id="L269">            checkPropertyNameIsValid(name);</span>
<span class="fc" id="L270">        } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L271">            return false;</span>
<span class="fc" id="L272">        }</span>

<span class="fc" id="L274">        return JmsMessagePropertyIntercepter.propertyExists(facade, name);</span>
    }

    @Override
    public Enumeration&lt;?&gt; getPropertyNames() throws JMSException {
<span class="fc" id="L279">        Set&lt;String&gt; result = new HashSet&lt;String&gt;();</span>

<span class="fc" id="L281">        Set&lt;String&gt; propertyNames = JmsMessagePropertyIntercepter.getPropertyNames(facade, true);</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">        for (String name : propertyNames) {</span>
            try {
<span class="fc" id="L284">                checkPropertyNameIsValid(name);</span>
<span class="fc" id="L285">            } catch (IllegalArgumentException iae) {</span>
                // Don't add the name
<span class="fc" id="L287">                continue;</span>
<span class="fc" id="L288">            }</span>

<span class="fc" id="L290">            result.add(name);</span>
<span class="fc" id="L291">        }</span>

<span class="fc" id="L293">        return Collections.enumeration(result);</span>
    }

    /**
     * return all property names, including standard JMS properties and JMSX
     * properties
     *
     * @return Enumeration of all property names on this message
     * @throws JMSException
     */
    public Enumeration&lt;?&gt; getAllPropertyNames() throws JMSException {
<span class="fc" id="L304">        Set&lt;String&gt; result = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L305">        result.addAll(JmsMessagePropertyIntercepter.getAllPropertyNames(facade));</span>
<span class="fc" id="L306">        return Collections.enumeration(result);</span>
    }

    @Override
    public void setObjectProperty(String name, Object value) throws JMSException {
<span class="fc" id="L311">        checkReadOnlyProperties();</span>
<span class="fc" id="L312">        checkPropertyNameIsValid(name);</span>
<span class="fc" id="L313">        checkValidObject(value);</span>
<span class="fc" id="L314">        JmsMessagePropertyIntercepter.setProperty(facade, name, value);</span>
<span class="fc" id="L315">    }</span>

    protected void checkValidObject(Object value) throws MessageFormatException {
<span class="fc bfc" id="L318" title="All 20 branches covered.">        boolean valid = value instanceof Boolean ||</span>
                        value instanceof Byte ||
                        value instanceof Short ||
                        value instanceof Integer ||
                        value instanceof Long ||
                        value instanceof Float ||
                        value instanceof Double ||
                        value instanceof Character ||
                        value instanceof String ||
                        value == null;

<span class="fc bfc" id="L329" title="All 2 branches covered.">        if (!valid) {</span>
<span class="fc" id="L330">            throw new MessageFormatException(&quot;Only objectified primitive objects and String types are allowed but was: &quot; + value + &quot; type: &quot; + value.getClass());</span>
        }
<span class="fc" id="L332">    }</span>

    @Override
    public Object getObjectProperty(String name) throws JMSException {
<span class="fc" id="L336">        checkPropertyNameIsValid(name);</span>
<span class="fc" id="L337">        return JmsMessagePropertyIntercepter.getProperty(facade, name);</span>
    }

    @Override
    public boolean getBooleanProperty(String name) throws JMSException {
<span class="fc" id="L342">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L343" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L344">            return false;</span>
        }
<span class="fc" id="L346">        Boolean rc = (Boolean) TypeConversionSupport.convert(value, Boolean.class);</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L348">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a boolean&quot;);</span>
        }
<span class="fc" id="L350">        return rc.booleanValue();</span>
    }

    @Override
    public byte getByteProperty(String name) throws JMSException {
<span class="fc" id="L355">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L357">            throw new NumberFormatException(&quot;property &quot; + name + &quot; was null&quot;);</span>
        }
<span class="fc" id="L359">        Byte rc = (Byte) TypeConversionSupport.convert(value, Byte.class);</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L361">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a byte&quot;);</span>
        }
<span class="fc" id="L363">        return rc.byteValue();</span>
    }

    @Override
    public short getShortProperty(String name) throws JMSException {
<span class="fc" id="L368">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L370">            throw new NumberFormatException(&quot;property &quot; + name + &quot; was null&quot;);</span>
        }
<span class="fc" id="L372">        Short rc = (Short) TypeConversionSupport.convert(value, Short.class);</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L374">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a short&quot;);</span>
        }
<span class="fc" id="L376">        return rc.shortValue();</span>
    }

    @Override
    public int getIntProperty(String name) throws JMSException {
<span class="fc" id="L381">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L382" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L383">            throw new NumberFormatException(&quot;property &quot; + name + &quot; was null&quot;);</span>
        }
<span class="fc" id="L385">        Integer rc = (Integer) TypeConversionSupport.convert(value, Integer.class);</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L387">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as an integer&quot;);</span>
        }
<span class="fc" id="L389">        return rc.intValue();</span>
    }

    @Override
    public long getLongProperty(String name) throws JMSException {
<span class="fc" id="L394">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L396">            throw new NumberFormatException(&quot;property &quot; + name + &quot; was null&quot;);</span>
        }
<span class="fc" id="L398">        Long rc = (Long) TypeConversionSupport.convert(value, Long.class);</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L400">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a long&quot;);</span>
        }
<span class="fc" id="L402">        return rc.longValue();</span>
    }

    @Override
    public float getFloatProperty(String name) throws JMSException {
<span class="fc" id="L407">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L409">            throw new NullPointerException(&quot;property &quot; + name + &quot; was null&quot;);</span>
        }
<span class="fc" id="L411">        Float rc = (Float) TypeConversionSupport.convert(value, Float.class);</span>
<span class="fc bfc" id="L412" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L413">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a float&quot;);</span>
        }
<span class="fc" id="L415">        return rc.floatValue();</span>
    }

    @Override
    public double getDoubleProperty(String name) throws JMSException {
<span class="fc" id="L420">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L422">            throw new NullPointerException(&quot;property &quot; + name + &quot; was null&quot;);</span>
        }
<span class="fc" id="L424">        Double rc = (Double) TypeConversionSupport.convert(value, Double.class);</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L426">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a double&quot;);</span>
        }
<span class="fc" id="L428">        return rc.doubleValue();</span>
    }

    @Override
    public String getStringProperty(String name) throws JMSException {
<span class="fc" id="L433">        Object value = getObjectProperty(name);</span>
<span class="fc bfc" id="L434" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L435">            return null;</span>
        }
<span class="fc" id="L437">        String rc = (String) TypeConversionSupport.convert(value, String.class);</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">        if (rc == null) {</span>
<span class="fc" id="L439">            throw new MessageFormatException(&quot;Property &quot; + name + &quot; was a &quot; + value.getClass().getName() + &quot; and cannot be read as a String&quot;);</span>
        }
<span class="fc" id="L441">        return rc;</span>
    }

    @Override
    public void setBooleanProperty(String name, boolean value) throws JMSException {
<span class="fc" id="L446">        setObjectProperty(name, Boolean.valueOf(value));</span>
<span class="fc" id="L447">    }</span>

    @Override
    public void setByteProperty(String name, byte value) throws JMSException {
<span class="fc" id="L451">        setObjectProperty(name, Byte.valueOf(value));</span>
<span class="fc" id="L452">    }</span>

    @Override
    public void setShortProperty(String name, short value) throws JMSException {
<span class="fc" id="L456">        setObjectProperty(name, Short.valueOf(value));</span>
<span class="fc" id="L457">    }</span>

    @Override
    public void setIntProperty(String name, int value) throws JMSException {
<span class="fc" id="L461">        setObjectProperty(name, Integer.valueOf(value));</span>
<span class="fc" id="L462">    }</span>

    @Override
    public void setLongProperty(String name, long value) throws JMSException {
<span class="fc" id="L466">        setObjectProperty(name, Long.valueOf(value));</span>
<span class="fc" id="L467">    }</span>

    @Override
    public void setFloatProperty(String name, float value) throws JMSException {
<span class="fc" id="L471">        setObjectProperty(name, new Float(value));</span>
<span class="fc" id="L472">    }</span>

    @Override
    public void setDoubleProperty(String name, double value) throws JMSException {
<span class="fc" id="L476">        setObjectProperty(name, new Double(value));</span>
<span class="fc" id="L477">    }</span>

    @Override
    public void setStringProperty(String name, String value) throws JMSException {
<span class="fc" id="L481">        setObjectProperty(name, value);</span>
<span class="fc" id="L482">    }</span>

    public JmsAcknowledgeCallback getAcknowledgeCallback() {
<span class="fc" id="L485">        return acknowledgeCallback;</span>
    }

    public void setAcknowledgeCallback(JmsAcknowledgeCallback acknowledgeCallback) {
<span class="fc" id="L489">        this.acknowledgeCallback = acknowledgeCallback;</span>
<span class="fc" id="L490">    }</span>

    /**
     * Used to trigger processing required to place the message in a state where it is
     * ready to be written to the wire.  This processing can include such tasks as ensuring
     * that the proper message headers are set or compressing message bodies etc.
     *
     * @param disableMessageId
     *        a hint that the user requested not to sent the MessageID if possible.
     * @param disableTimestamp
     *        a hint that the user requested not to sent the MessageID if possible.
     * @param producerTtl
     *        the time to live value that the producer was configured with at send time.
     *
     * @throws JMSException if an error occurs while preparing the message for send.
     */
    public void onSend(boolean disableMessageId, boolean disableTimestamp, long producerTtl) throws JMSException {
<span class="fc" id="L507">        setReadOnlyBody(true);</span>
<span class="fc" id="L508">        setReadOnlyProperties(true);</span>
<span class="fc" id="L509">        facade.onSend(disableMessageId, disableTimestamp, producerTtl);</span>
<span class="fc" id="L510">    }</span>

    /**
     * Used to trigger processing required before dispatch of a message to its intended
     * consumer.  This method should perform any needed unmarshal or message property
     * processing prior to the message arriving at a consumer.
     *
     * @throws JMSException if an error occurs while preparing the message for dispatch.
     */
    public void onDispatch() throws JMSException {
<span class="fc" id="L520">        setReadOnlyBody(true);</span>
<span class="fc" id="L521">        setReadOnlyProperties(true);</span>
<span class="fc" id="L522">        facade.onDispatch();</span>
<span class="fc" id="L523">    }</span>

    public JmsConnection getConnection() {
<span class="fc" id="L526">        return connection;</span>
    }

    public void setConnection(JmsConnection connection) {
<span class="fc" id="L530">        this.connection = connection;</span>
<span class="fc" id="L531">    }</span>

    public JmsMessageFacade getFacade() {
<span class="fc" id="L534">        return this.facade;</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L539">        return &quot;JmsMessage { &quot; + facade + &quot; }&quot;;</span>
    }

    protected void checkReadOnlyProperties() throws MessageNotWriteableException {
<span class="fc bfc" id="L543" title="All 2 branches covered.">        if (readOnlyProperties) {</span>
<span class="fc" id="L544">            throw new MessageNotWriteableException(&quot;Message properties are read-only&quot;);</span>
        }
<span class="fc" id="L546">    }</span>

    protected void checkReadOnlyBody() throws MessageNotWriteableException {
<span class="fc bfc" id="L549" title="All 2 branches covered.">        if (readOnlyBody) {</span>
<span class="fc" id="L550">            throw new MessageNotWriteableException(&quot;Message body is read-only&quot;);</span>
        }
<span class="fc" id="L552">    }</span>

    protected void checkWriteOnlyBody() throws MessageNotReadableException {
<span class="fc bfc" id="L555" title="All 2 branches covered.">        if (!readOnlyBody) {</span>
<span class="fc" id="L556">            throw new MessageNotReadableException(&quot;Message body is write-only&quot;);</span>
        }
<span class="fc" id="L558">    }</span>

    private void checkPropertyNameIsValid(String propertyName) throws IllegalArgumentException {
<span class="fc bfc" id="L561" title="All 2 branches covered.">        if (propertyName == null) {</span>
<span class="fc" id="L562">            throw new IllegalArgumentException(&quot;Property name must not be null&quot;);</span>
<span class="fc bfc" id="L563" title="All 2 branches covered.">        } else if (propertyName.length() == 0) {</span>
<span class="fc" id="L564">            throw new IllegalArgumentException(&quot;Property name must not be the empty string&quot;);</span>
        }

<span class="fc bfc" id="L567" title="All 2 branches covered.">        if (isValidatePropertyNames()) {</span>
<span class="fc" id="L568">            checkIdentifierLetterAndDigitRequirements(propertyName);</span>
<span class="fc" id="L569">            checkIdentifierIsntNullTrueFalse(propertyName);</span>
<span class="fc" id="L570">            checkIdentifierIsntLogicOperator(propertyName);</span>
        }
<span class="fc" id="L572">    }</span>

    private void checkIdentifierIsntLogicOperator(String identifier) {
        // Identifiers cannot be NOT, AND, OR, BETWEEN, LIKE, IN, IS, or ESCAPE.
<span class="fc bfc" id="L576" title="All 16 branches covered.">        if (&quot;NOT&quot;.equals(identifier) || &quot;AND&quot;.equals(identifier) || &quot;OR&quot;.equals(identifier) ||</span>
            &quot;BETWEEN&quot;.equals(identifier) || &quot;LIKE&quot;.equals(identifier) || &quot;IN&quot;.equals(identifier) ||
            &quot;IS&quot;.equals(identifier) || &quot;ESCAPE&quot;.equals(identifier)) {

<span class="fc" id="L580">            throw new IllegalArgumentException(&quot;Identifier not allowed in JMS: '&quot; + identifier + &quot;'&quot;);</span>
        }
<span class="fc" id="L582">    }</span>

    private void checkIdentifierIsntNullTrueFalse(String identifier) {
        // Identifiers cannot be the names NULL, TRUE, and FALSE.
<span class="fc bfc" id="L586" title="All 6 branches covered.">        if (&quot;NULL&quot;.equals(identifier) || &quot;TRUE&quot;.equals(identifier) || &quot;FALSE&quot;.equals(identifier)) {</span>
<span class="fc" id="L587">            throw new IllegalArgumentException(&quot;Identifier not allowed in JMS: '&quot; + identifier + &quot;'&quot;);</span>
        }
<span class="fc" id="L589">    }</span>

    private void checkIdentifierLetterAndDigitRequirements(String identifier) {
        // An identifier is an unlimited-length sequence of letters and digits, the first of
        // which must be a letter.  A letter is any character for which the method
        // Character.isJavaLetter returns true.  This includes '_' and '$'.  A letter or digit
        // is any character for which the method Character.isJavaLetterOrDigit returns true.
<span class="fc" id="L596">        char startChar = identifier.charAt(0);</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">        if (!(Character.isJavaIdentifierStart(startChar))) {</span>
<span class="fc" id="L598">            throw new IllegalArgumentException(&quot;Identifier does not begin with a valid JMS identifier start character: '&quot; + identifier + &quot;' &quot;);</span>
        }

        // JMS part character
<span class="fc" id="L602">        int length = identifier.length();</span>
<span class="fc bfc" id="L603" title="All 2 branches covered.">        for (int i = 1; i &lt; length; i++) {</span>
<span class="fc" id="L604">            char ch = identifier.charAt(i);</span>
<span class="fc bfc" id="L605" title="All 2 branches covered.">            if (!(Character.isJavaIdentifierPart(ch))) {</span>
<span class="fc" id="L606">                throw new IllegalArgumentException(&quot;Identifier contains invalid JMS identifier character '&quot; + ch + &quot;': '&quot; + identifier + &quot;' &quot;);</span>
            }
        }
<span class="fc" id="L609">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>